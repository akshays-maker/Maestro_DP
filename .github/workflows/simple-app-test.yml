name: Simple App Test - Community Stable Config

on:
  workflow_dispatch:

jobs:
  test-app-installation:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Increase Swap Memory (Community Fix)
        run: |
          sudo fallocate -l 4G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          echo "âœ… Swap memory added successfully"

      - name: Prepare simple test script
        run: |
          cat > simple_test.sh << 'EOF'
          #!/usr/bin/env bash
          set -e
          echo "=== SIMPLE APP TEST ==="
          adb wait-for-device
          timeout 180 bash -c 'until adb shell getprop sys.boot_completed | grep -m 1 1; do sleep 2; done'
          adb shell input keyevent 82 || true
          sleep 20
          
          # Best-effort animation disable (ignore failures)
          adb shell settings put global window_animation_scale 0 || true
          adb shell settings put global transition_animation_scale 0 || true
          adb shell settings put global animator_duration_scale 0 || true
          
          APK_FILE=$(find . -name "*.apk" -type f | head -1)
          echo "APK: $APK_FILE"
          adb install -r "$APK_FILE"
          
          PACKAGE_NAME=waterwala.com.prime
          adb shell monkey -p "$PACKAGE_NAME" -c android.intent.category.LAUNCHER 1 || true
          sleep 8
          
          # Capture a screenshot regardless of app state
          adb shell screencap -p > app_test_screenshot.png || true
          # Dump logcat for debugging
          adb logcat -d > app_test_logcat.txt || true
          EOF
          chmod +x simple_test.sh

      - name: Start Emulator and Test App (Proven Stable Config)
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          target: default
          arch: x86_64
          profile: pixel
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          disable-animations: false
          script: ./simple_test.sh

      - name: Upload screenshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: app-test-artifacts
          path: |
            app_test_screenshot.png
            app_test_logcat.txt