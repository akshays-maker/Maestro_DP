name: Simple App Test - Community Stable Config

on:
  workflow_dispatch:

jobs:
  test-app-installation:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Increase Swap Memory (Community Fix)
        run: |
          sudo fallocate -l 4G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          echo "✅ Swap memory added successfully"

      - name: Start Emulator and Test App (Proven Stable Config)
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          target: default
          arch: x86_64
          profile: pixel
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          disable-animations: false
          script: |
            echo "=== COMMUNITY STABLE EMULATOR TEST ==="
            
            # Wait for device
            adb wait-for-device
            echo "Device detected, waiting for boot completion..."
            
            # Wait for boot completion
            timeout 120 bash -c 'while [[ -z $(adb shell getprop sys.boot_completed 2>/dev/null) ]]; do sleep 2; echo "Still booting..."; done' || echo "Boot timeout"
            
            # Wake up emulator
            adb shell input keyevent 82
            
            # Community recommended wait
            sleep 30
            
            echo "=== DEVICE INFORMATION ==="
            echo "Device model: $(adb shell getprop ro.product.model)"
            echo "Android version: $(adb shell getprop ro.build.version.release)" 
            echo "API level: $(adb shell getprop ro.build.version.sdk)"
            echo "CPU ABI: $(adb shell getprop ro.product.cpu.abi)"
            echo "Available ABIs: $(adb shell getprop ro.product.cpu.abilist)"
            echo "==============================="
            
            # Disable animations (ignore failures)
            echo "Disabling animations..."
            adb shell settings put global window_animation_scale 0 || echo "Animation setting failed (normal in CI)"
            adb shell settings put global transition_animation_scale 0 || echo "Transition setting failed (normal in CI)"
            adb shell settings put global animator_duration_scale 0 || echo "Animator setting failed (normal in CI)"
            
            APK_FILE=$(find . -name "*.apk" -type f | head -1)
            echo "Found APK: $APK_FILE"
            
            echo "Installing APK..."
            adb install -r "$APK_FILE"
            
            echo "Verifying installation..."
            adb shell pm list packages | grep -E "(prime|drink|waterwala)" && echo "✅ Package found" || echo "❌ Package not found"
            
            PACKAGE_NAME="waterwala.com.prime"
            echo "Attempting to start $PACKAGE_NAME..."
            
            # Launch app
            adb shell monkey -p "$PACKAGE_NAME" -c android.intent.category.LAUNCHER 1
            sleep 10
            
            echo "Checking if app is running..."
            adb shell ps | grep "$PACKAGE_NAME" && echo "✅ App is running!" || echo "❌ App not running"
            
            echo "Taking screenshot..."
            adb shell screencap -p > app_test_screenshot.png
            
            echo "Checking recent logcat for errors..."
            adb logcat -d | tail -30

      - name: Upload screenshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: app-test-screenshot
          path: app_test_screenshot.png