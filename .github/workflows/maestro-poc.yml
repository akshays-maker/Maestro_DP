name: Maestro POC

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  run-maestro-poc:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Increase Swap Memory (Fix 7)
        run: |
          sudo fallocate -l 4G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          echo "Swap memory added successfully"

      - name: Install Maestro
        run: |
          curl -Ls https://get.maestro.mobile.dev | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Check repository contents
        run: |
          echo "=== Repository structure ==="
          find . -name "*.apk" -type f 2>/dev/null || echo "No APK files found"
          echo ""
          echo "=== Maestro directory ==="
          ls -la Maestro/

      - name: Start Emulator and Run Test
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          target: default
          arch: x86_64
          profile: pixel
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          disable-animations: false
          script: |
            echo "=== COMMUNITY STABLE EMULATOR CONFIG ==="
            
            # Fix 2: Long boot timeout - wait for device properly
            adb wait-for-device
            echo "Device detected, waiting for boot completion..."
            
            # Wait for boot completion with longer timeout
            timeout 120 bash -c 'while [[ -z $(adb shell getprop sys.boot_completed 2>/dev/null) ]]; do sleep 2; echo "Still booting..."; done' || echo "Boot timeout reached"
            
            # Fix 5: Wake up emulator
            adb shell input keyevent 82
            
            # Fix 2: Additional wait for system to stabilize (community recommendation)
            echo "Waiting 30 seconds for system stabilization..."
            sleep 30
            
            # Verify emulator is ready
            echo "Final device check:"
            adb devices
            
            echo "=== DEVICE INFORMATION ==="
            adb shell getprop ro.product.model
            adb shell getprop ro.build.version.release
            adb shell getprop ro.build.version.sdk
            adb shell getprop ro.product.cpu.abi
            echo "==============================="
            
            # Fix 3: Disable animations inside emulator (ignore errors - common issue)
            echo "Disabling animations..."
            adb shell settings put global window_animation_scale 0 || echo "Animation setting failed (common in CI)"
            adb shell settings put global transition_animation_scale 0 || echo "Transition setting failed (common in CI)"  
            adb shell settings put global animator_duration_scale 0 || echo "Animator setting failed (common in CI)"
            
            # Install APK
            APK_FILE=$(find . -name "*.apk" -type f | head -1)
            if [ -z "$APK_FILE" ]; then
              echo "No APK found"
              exit 1
            fi
            
            echo "Installing: $APK_FILE"
            adb install -r "$APK_FILE"
            
            # Verify app installation
            PACKAGE_NAME="waterwala.com.prime"
            adb shell pm list packages | grep prime && echo "✅ App installed successfully" || echo "❌ App installation verification failed"
            
            # Grant permissions (ignore failures)
            echo "Granting permissions..."
            adb shell pm grant "$PACKAGE_NAME" android.permission.READ_PHONE_STATE 2>/dev/null || echo "Phone permission not needed"
            adb shell pm grant "$PACKAGE_NAME" android.permission.INTERNET 2>/dev/null || echo "Internet permission not needed"
            
            # Launch app and wait for it to start
            echo "Launching app..."
            adb shell monkey -p "$PACKAGE_NAME" -c android.intent.category.LAUNCHER 1
            sleep 10
            
            # Check if app is running
            adb shell ps | grep "$PACKAGE_NAME" && echo "✅ App is running!" || echo "❌ App not running - checking logs..."
            if ! adb shell ps | grep -q "$PACKAGE_NAME"; then
              echo "App crash logs:"
              adb logcat -d | grep -E "($PACKAGE_NAME|AndroidRuntime|FATAL)" | tail -10
            fi
            
            cd Maestro
            echo "Running Maestro tests with retry logic (Fix 6)..."
            
            # Fix 6: Retry logic around maestro execution
            echo "Running crash debug flow..."
            maestro test crash_debug_flow.yaml || (echo "Retrying crash debug..." && sleep 10 && maestro test crash_debug_flow.yaml) || echo "Crash debug flow failed"
            
            echo "Running debug flow..."
            maestro test debug_flow.yaml || (echo "Retrying debug..." && sleep 10 && maestro test debug_flow.yaml) || echo "Debug flow failed"
            
            echo "Running sample flow with ID-based targeting..."
            maestro test sample_flow.yaml || (echo "Retrying sample..." && sleep 10 && maestro test sample_flow.yaml) || echo "Sample flow failed"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-results
          path: |
            Maestro/*.yaml
            Maestro/*.png
            ~/.maestro/logs/
