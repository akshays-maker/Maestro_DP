name: Maestro POC

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  run-maestro-poc:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Increase Swap Memory (Fix 7)
        run: |
          sudo fallocate -l 4G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          echo "Swap memory added successfully"

      - name: Install Maestro
        run: |
          curl -Ls https://get.maestro.mobile.dev | bash
          echo "$HOME/.maestro/bin" >> $GITHUB_PATH

      - name: Check repository contents
        run: |
          echo "=== Repository structure ==="
          find . -name "*.apk" -type f 2>/dev/null || echo "No APK files found"
          echo ""
          echo "=== Maestro directory ==="
          ls -la Maestro/

      - name: Prepare test script (simple)
        run: |
          cat > run_test.sh << 'EOF'
          #!/usr/bin/env bash
          set -e
          echo "=== SIMPLE MAESTRO RUN ==="
          adb wait-for-device
          timeout 180 bash -c 'until adb shell getprop sys.boot_completed | grep -m 1 1; do sleep 2; done'
          adb shell input keyevent 82 || true
          sleep 20

          # Best-effort animation disable (ignore errors)
          adb shell settings put global window_animation_scale 0 || true
          adb shell settings put global transition_animation_scale 0 || true
          adb shell settings put global animator_duration_scale 0 || true

          APK_FILE=$(find . -name "*.apk" -type f | head -1)
          echo "APK: $APK_FILE"
          adb install -r "$APK_FILE"

          PACKAGE_NAME=waterwala.com.prime
          adb shell monkey -p "$PACKAGE_NAME" -c android.intent.category.LAUNCHER 1 || true
          sleep 8

          cd Maestro
          maestro test sample_flow.yaml || true
          maestro test debug_flow.yaml || true
          maestro test crash_debug_flow.yaml || true
          # Capture final screenshot and logcat for diagnostics
          adb shell screencap -p > final_screenshot.png || true
          adb logcat -d > maestro_logcat.txt || true
          EOF
          chmod +x run_test.sh

      - name: Start Emulator and Run Test
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 29
          target: default
          arch: x86_64
          profile: pixel
          emulator-options: -no-snapshot-save -no-window -gpu swiftshader_indirect -noaudio -no-boot-anim
          disable-animations: false
          script: ./run_test.sh

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maestro-results
          path: |
            Maestro/*.yaml
            Maestro/*.png
            Maestro/*.txt
            ~/.maestro/logs/
